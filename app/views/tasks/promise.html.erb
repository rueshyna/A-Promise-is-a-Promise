<div id='dialog' title="Do promise">
  <div id="accordion">
    <h3><a href="#">Promise</a></h3>
    <div>
      <form>
      <fieldset>
        <p><label for="goal">Your Goal is...</label></p>
        <p><input type="text" name="goal" id="goal" value="" class="text ui-widget-content ui-corner-all" /></p>
        <p><label for="when">When?</label></p>
        <p><input type="radio" name="when" class="when" value="Morning" class="text ui-widget-content ui-corner-all" />Morning
        <input type="radio" name="when" class="when" value="Afternoon" class="text ui-widget-content ui-corner-all" />Afternoon
        <input type="radio" name="when" class="when" value="Evening" class="text ui-widget-content ui-corner-all" />Evening</p>
        <p><label for="howlong">How Long?</label></p>
        <p><input type="text" name="howlong" id="howlong" value="" class="text ui-widget-content ui-corner-all" />Minutes</p>
      </fieldset>
      </form>
    </div>
    <h3><a href="#">Check</a></h3>
    <div></div>
  </div>
</div>
<div id='tips'></div>

<div id="tabs">
 <ul>
   <li><a href="#tabs-1">Do promise</a></li>
   <li><a href="#tabs-2">Partner's status</a></li>
 </ul>

  <div id="tabs-1">
    <div id='calendar'></div>
  </div>
  <div id="tabs-2">
  </div>
</div>

<% content_for :js_ready do %>
  $("#tabs").tabs();
  $("#accordion").accordion({
   active: false,
   collapsible: true
  });
  var goal = $("#goal"),
      howlong = $("#howlong"),
      allFields = $([]).add(goal).add(howlong);
  $('#dialog').dialog({autoOpen: false});
  $('#tips').dialog({autoOpen: false});

  var calendar = $('#calendar').fullCalendar({
    header:{
      left: 'prev,next today',
      center: 'title',
      right: 'month,agendaWeek,agendaDay'
    },
    selectable: true,
    selectHelper: true,
    select:
      function(start, end, allDay){
        $('#dialog').dialog({
           height: 550,
           width: 500,
           modal: true,
           buttons: {
             Cancel: function() {
               $(this).dialog('close');
             },
             'OK': function(){
               if (goal.val()){
                 $.getJSON("/dopromise" , {
                   "title" : goal.val(),
                   "when" : $("input[name=when]:checked").val(),
                   "howlong" : howlong.val(),
                   "start" : start+"",
                   "end" : end+"",
                   "allDay" : allDay
                 },function(json){
                  calendar.fullCalendar('renderEvent',{
                    id:json[0],
                    title: json[1],
                    start: json[2],
                    end: json[3],
                    allDay: json[4]
                  },
                  false);
                })
               }
               $(this).dialog('close');
             }
           },
           close: function() {
             $("input[name=when]").attr("checked", false);
             allFields.val('').removeClass('ui-state-error');
           }
        });
        $('#dialog').dialog('open');
        calendar.fullCalendar('unselect');
      },
      events:"/loadpromise",
      eventClick: function(calEvent, jsEvent, view){
        $.getJSON("/editpromise",{
          "id":calEvent.id
        },function(json){
          $("#goal").val(json[0]);
          $("#howlong").val(json[2]);


      $('#dialog').dialog({
           title: 'Edit',
           height: 420,
           width: 400,
           modal: true,
           buttons: {
             Cancel: function() {
               $(this).dialog('close');
             },
             'Update': function(){
               if (goal.val()){
                 $.getJSON("/updatepromise" , {
                   "id": calEvent.id,
                   "title" : goal.val(),
                   "when" : $("input[name=when]:checked").val(),
                   "howlong" : howlong.val(),
                 },function(json){
                 })
                   calendar.fullCalendar('refetchEvents');
               }
               $(this).dialog('close');
             }
           },
           close: function() {
             allFields.val('').removeClass('ui-state-error');
           }
        });
        $('#dialog').dialog('open');


        })
      },
      eventMouseover: function(calEvent, jsEvent, view){
        $.getJSON("/promisetips",{
          "id":calEvent.id
        },function(json){
          $("#tips").html(
             "<i>Your Goal is </i><b>" + json[0] + "</b><br/>" +
             "<i>When?</i> <b>" + json[1] + "</b><br/>" +
             "<i>How Long?</i> <b>" + json[2] + "</b> <i>minutes</i><br/>"
           );
          $("#tips").dialog({
            title : "Don't forget it...",
            position : [jsEvent.pageX-70, jsEvent.pageY-100],
            width : 370,
            height : 130
          })
          $("#tips").dialog('open');
        })
      },
      eventMouseout: function(calEvent, jsEvent, view){
        $("#tips").dialog('close')
      }
  });
<% end %>
